#!/usr/bin/env bash
set -euo pipefail

export PATH="$HOME/.local/bin:$PATH"

menu() {
  local prompt="$1"
  local options="$2"
  local extra="${3:-}"
  local preselect="${4:-}"

  local -a args=()
  # allow passing flags to menu-pick/walker (ex: --width 800 --minheight 400)
  if [[ -n "$extra" ]]; then
    # shellcheck disable=SC2206
    args+=($extra)
  fi

  # If we have a preselect value, compute its 1-based line index and pass -c <index>
  # (Walker dmenu compat; if your menu-pick doesn't support -c, we'll adjust)
  if [[ -n "$preselect" ]]; then
    local idx
    idx="$(printf "%b" "$options" | grep -nxF "$preselect" | cut -d: -f1 | head -n1 || true)"
    if [[ -n "$idx" ]]; then
      args+=("-c" "$idx")
    fi
  fi

  printf "%b" "$options" | menu-pick "$prompt" "${args[@]}"
}

open_url() {
  xdg-open "$1" >/dev/null 2>&1 &
  disown || true
}

open_terminal() {
  xdg-terminal-exec --class="org.cachy.terminal" -e bash -lc "${1:-bash}" &
  disown || true
}

open_editor() {
  xdg-terminal-exec --class="org.cachy.editor" -e bash -lc "launch-editor ${1:+\"$1\"}"
  disown || true
}

tui() {
  # Run a command in a floating “menu TUI” terminal
  xdg-terminal-exec --class="org.cachy.tui" -e bash -lc "$*" &
  disown || true
}

present() {
  # Like tui(), but intended for long-running / install output; same window rules
  xdg-terminal-exec --class="org.cachy.present" -e bash -lc "$*" &
  disown || true
}

main_menu() {
  case "$(menu "Go" \
    "󰀻  Apps
󰧑  Learn
󱓞  Trigger
  Style
󰉉  Manage
  Setup
  About
  System")" in
  *Apps*) walker -p "Launch…" ;;
  *Learn*) learn_menu ;;
  *Trigger*) trigger_menu ;;
  *Style*) style_menu ;;
  *Manage*) manage_menu ;;
  *Setup*) setup_menu ;;
  *About*)
    notify-send "Cachy Menu" "v0.1" && launch-or-focus-tui fastfetch &
    sleep 5
    ;;
  *System*) system_menu ;;
  *) exit 0 ;;
  esac
}

learn_menu() {
  case "$(menu "Learn" \
    "  Hyprland Wiki
󰣇  Arch Wiki
󱆃  Bash cheatsheet
  LazyVim keymaps")" in
  *Hyprland*) open_url "https://wiki.hypr.land/" ;;
  *Arch*) open_url "https://wiki.archlinux.org/" ;;
  *Bash*) open_url "https://devhints.io/bash" ;;
  *LazyVim*) open_url "https://www.lazyvim.org/keymaps" ;;
  esac
  exit 0
}

trigger_menu() {
  case "$(menu "Trigger" \
    "  Screenshot
  Screenrecord
󰃉  Color picker")" in
  *Screenshot*) cmd-screenshot && notify-send "Screenshot taken" ;;
  *Screenrecord*) cmd-screenrecord && notify-send "Screenrecording.." ;;
  *Color*) pkill hyprpicker || hyprpicker -a ;;
  esac
  exit 0
}

style_menu() {
  case "$(menu "Style" \
    "󰸌  Themes
      Edit Hyprland look
󰍜  Toggle Waybar")" in
  *Themes*) theme_menu ;;
  *Hyprland*) open_editor "$HOME/.config/hypr/looknfeel.conf" ;;
  *Waybar*) pkill waybar && notify-send "Waybar" "Stopped" || (
    waybar &
    disown && notify-send "Waybar" "Started"
  ) ;;
  esac
  exit 0
}

setup_menu() {
  case "$(menu "Setup" \
    "  Edit Hyprland config
󰌧  Edit Walker config
󰍜  Edit Waybar config")" in
  *Hyprland*) open_editor "$HOME/.config/hypr/hyprland.conf" ;;
  *Walker*) open_editor "$HOME/.config/walker/config.toml" ;;
  *Waybar*) open_editor "$HOME/.config/waybar/config.jsonc" ;;
  esac
  exit 0
}

system_menu() {
  case "$(menu "System" \
    "  Lock
󰜉  Restart
󰐥  Shutdown")" in
  *Lock*) hyprlock ;;
  *Restart*) cmd-reboot ;;
  *Shutdown*) cmd-shutdown ;;
  esac
  exit 0
}

theme_menu() {
  echo "Trying..."
  local dir="$HOME/.config/themes"
  local themes sel

  themes="$(find "$dir" -mindepth 1 -maxdepth 1 -type d -printf '%f\n' |
    rg -v '^(current)$' |
    sort)"

  if [[ -z "$themes" ]]; then
    notify-send "Themes" "No theme directories found in $dir"
    return 0
  fi

  # IMPORTANT: call menu-pick via PATH, so make sure it exists.
  sel="$(printf "%s\n" "$themes" | menu-pick "Themes" --width 800 --minheight 400 || true)"
  [[ -n "$sel" ]] || return 0

  # Apply theme and close menu immediately
  theme-set "$sel" >/dev/null 2>&1 &
  disown || true
  exit 0
}

manage_menu() {
  case "$(menu "Manage" \
    "󰔎  Toggle
  Restart
󰣇  Install
󰭌  Remove")" in
  *Toggle*) manage_toggle_menu ;;
  *Restart*) manage_restart_menu ;;
  *Install*) manage_install_menu ;;
  *Remove*) manage_remove_menu ;;
  esac
  exit 0
}

manage_toggle_menu() {
  case "$(menu "Toggle" \
    "󰍜  Waybar
󰔎  Nightlight
󱫖  Idle Lock
󱄄  Screensaver")" in
  *Waybar*) toggle-waybar ;;
  *Nightlight*) toggle-nightlight ;;
  *Idle*) toggle-idle ;;
  esac
  exit 0
}

manage_restart_menu() {
  case "$(menu "Restart" \
    "󰂯  Bluetooth
  btop
  Hyprctl
  PipeWire
󱂬  SwayNC
󰍝  SwayOSD
󰌧  Walker
󰍜  Waybar
󱚾  Wi-Fi")" in
  *Bluetooth*) restart-bluetooth ;;
  *btop*) restart-btop ;;
  *Hyprctl*) restart-hyprctl ;;
  *PipeWire*) restart-pipewire ;;
  *SwayNC*) restart-swaync ;;
  *SwayOSD*) restart-swayosd ;;
  *Walker*) restart-walker ;;
  *Waybar*) restart-waybar ;;
  *Wi-Fi*) restart-wifi ;;
  esac
  exit 0
}

manage_install_menu() {
  case "$(menu "Install" \
    "󰣇  Package (repo)
󰣇  Package (AUR)
  Misc")" in
  *repo*) present pkg-install ;;
  *AUR*) present pkg-aur-install ;;
  *Package*) present pkg-install ;;
  esac
  exit 0
}

manage_remove_menu() {
  case "$(menu "Remove" \
    "󰣇  Remove package
󰣇  Remove orphan/extra
󰣇  Remove AUR package")" in
  *"Remove package"*) pkg-remove ;;
  *orphan*) pkg-drop ;;
  *AUR*) pkg-aur-remove ;;
  esac
  exit 0
}

jump() {
  case "${1:-}" in
  style) style_menu ;;
  themes) theme_menu ;;
  manage) manage_menu ;;
  toggle) manage_toggle_menu ;;
  restart) manage_restart_menu ;;
  install) manage_install_menu ;;
  remove) manage_remove_menu ;;
  *) main_menu ;;
  esac
}

# Allow calling: menu <section>
jump "${1:-}"

main_menu

case "${1:-}" in
themes) theme_menu ;;
*) main_menu ;;
esac
