#!/usr/bin/env bash
set -euo pipefail

export PATH="$HOME/.local/bin:$PATH"

menu() {
  local prompt="$1"
  local options="$2"
  local extra="${3:-}"
  local preselect="${4:-}"

  local -a args=()
  # allow passing flags to menu-pick/walker (ex: --width 800 --minheight 400)
  if [[ -n "$extra" ]]; then
    # shellcheck disable=SC2206
    args+=($extra)
  fi

  # If we have a preselect value, compute its 1-based line index and pass -c <index>
  # (Walker dmenu compat; if your menu-pick doesn't support -c, we'll adjust)
  if [[ -n "$preselect" ]]; then
    local idx
    idx="$(printf "%b" "$options" | grep -nxF "$preselect" | cut -d: -f1 | head -n1 || true)"
    if [[ -n "$idx" ]]; then
      args+=("-c" "$idx")
    fi
  fi

  printf "%b" "$options" | menu-pick "$prompt" "${args[@]}"
}

open_url() {
  xdg-open "$1" >/dev/null 2>&1 &
  disown || true
}

open_terminal() {
  xdg-terminal-exec --class="org.cachy.terminal" -e bash -lc "${1:-bash}" &
  disown || true
}

open_editor() {
  xdg-terminal-exec --class="org.cachy.editor" -e bash -lc "launch-editor ${1:+\"$1\"}"
  disown || true
}

tui() {
  # Run a command in a floating “menu TUI” terminal
  xdg-terminal-exec --class="org.cachy.tui" -e bash -lc "$*" &
  disown || true
}

present() {
  # Like tui(), but intended for long-running / install output; same window rules
  xdg-terminal-exec --class="org.cachy.present" -e bash -lc "$*" &
  disown || true
}

main_menu() {
  case "$(menu "Go" \
    "󰀻  Apps
󰧑  Learn
󱓞  Trigger
  Style
󰉉  Manage
  Setup
  About
  System")" in
  *Apps*) walker -p "Launch…" ;;
  *Learn*) learn_menu ;;
  *Trigger*) trigger_menu ;;
  *Style*) style_menu ;;
  *Manage*) manage_menu ;;
  *Setup*) setup_menu ;;
  *About*)
    notify-send "Cachy Menu" "v0.1" && tui "fastfetch; exec show-done" && exit 0
    ;;
  *System*) system_menu ;;
  *) exit 0 ;;
  esac
}

learn_menu() {
  case "$(menu "Learn" \
    "  Hyprland Wiki
󰣇  Arch Wiki
󱆃  Bash cheatsheet
  LazyVim keymaps
Return to Main Menu")" in
  *Hyprland*) open_url "https://wiki.hypr.land/" ;;
  *Arch*) open_url "https://wiki.archlinux.org/" ;;
  *Bash*) open_url "https://devhints.io/bash" ;;
  *LazyVim*) open_url "https://www.lazyvim.org/keymaps" ;;
  *Return*) main_menu ;;
  esac
  exit 0
}

trigger_menu() {
  case "$(menu "Trigger" \
    "  Screenshot
  Screenrecord
󰃉  Color picker")" in
  *Screenshot*) cmd-screenshot && notify-send "Screenshot taken" ;;
  *Screenrecord*) cmd-screenrecord && notify-send "Screenrecording.." ;;
  *Color*) pkill hyprpicker || hyprpicker -a ;;
  esac
  exit 0
}

style_menu() {
  case "$(menu "Style" \
    "󰸌  Themes
      Hyprland look
    󰍜  Waybar style
󰌧  Walker style
󰕿  SwayOSD style
󰎟  SwayNC style
󰍜  Toggle Waybar
Return to Main Menu")" in
  *Themes*) theme_menu ;;
  *Hyprland*) open_editor "$HOME/.config/themes/current/hyprland.conf" ;;
  *Waybar*) open_editor "$HOME/.config/waybar/style.css" ;;
  *Walker*) open_editor "$HOME/.config/walker/themes/kazuki-1/style.css" ;;
  *SwayOSD*) open_editor "$HOME/.config/swayosd/style.css" ;;
  *Swaync*) open_editor "$HOME/.config/swaync/style.css" ;;
  *Waybar*) pkill waybar && notify-send "Waybar" "Stopped" || (
    waybar &
    disown && notify-send "Waybar" "Started"
  ) ;;
  *Return*) main_menu ;;
  esac
  exit 0
}

setup_menu() {
  case "$(menu "Setup" \
    "  Hyprland config
󰌧  Walker config
󰍜  Waybar config
  Kitty config
󰕿  SwayOSD config
󰘚  Starship config
  Neovim config
󰄪  btop config
Return to Main Menu")" in
  *Hyprland*) open_editor "$HOME/.config/hypr/hyprland.conf" ;;
  *Walker*) open_editor "$HOME/.config/walker/config.toml" ;;
  *Waybar*) open_editor "$HOME/.config/waybar/config.jsonc" ;;
  *Kitty*) open_editor "$HOME/.config/kitty/kitty.conf" ;;
  *SwayOSD*) open_editor "$HOME/.config/swayosd/config.toml" ;;
  *Starship*) open_editor "$HOME/.config/starship.toml" ;;
  *Neovim*) open_editor "$HOME/.config/nvim/init.lua" ;;
  *Btop*) open_editor "$HOME/.config/btop/btop.conf" ;;
  *Return*) main_menu ;;

  esac
  exit 0
}

system_menu() {
  case "$(menu "System" \
    "󱐋  Power Profiles
  Lock
󰜉  Restart
󰐥  Shutdown
Return to Main Menu")" in
  *Power*) power_profiles_menu ;;
  *Lock*) launch-hyprlock ;;
  *Restart*) cmd-reboot ;;
  *Shutdown*) cmd-shutdown ;;
  *Return*) main_menu ;;
  esac
  exit 0
}

power_profiles_menu() {
  local profiles sel
  profiles="$(powerprofiles-list 2>/dev/null || true)"
  [[ -n "${profiles//$'\n'/}" ]] || {
    notify-send "Power Profiles" "No profiles found"
    return 0
  }

  sel="$(printf "%s\n" "$profiles" | menu-pick "Power Profiles" 420 1 300 || true)"
  [[ -n "$sel" ]] || return 0

  powerprofilesctl set "$sel" >/dev/null 2>&1 &&
    notify-send "Power Profiles" "Set to: $sel" ||
    notify-send "Power Profiles" "Failed to set: $sel" -u critical
}

theme_menu() {
  local dir="$HOME/.config/themes"
  local log="/tmp/cachy-menu-theme.log"
  : >"$log"

  echo "theme_menu start: $(date)" >>"$log"
  echo "PATH=$PATH" >>"$log"

  # Ensure menu-pick is available
  if ! command -v menu-pick >/dev/null 2>&1; then
    echo "ERROR: menu-pick not found" >>"$log"
    notify-send "Themes" "menu-pick not found (see $log)"
    return 1
  fi

  # Build theme list: directories only, exclude "current" and hidden dirs
  local themes=""
  while IFS= read -r name; do
    [[ "$name" == "current" ]] && continue
    [[ "$name" == .* ]] && continue
    themes+="$name"$'\n'
  done < <(find "$dir" -mindepth 1 -maxdepth 1 -type d -printf '%f\n' 2>>"$log" | sort)

  if [[ -z "${themes//$'\n'/}" ]]; then
    echo "No themes found in $dir" >>"$log"
    notify-send "Themes" "No theme directories found in $dir"
    return 0
  fi

  echo "Themes list:" >>"$log"
  printf "%s" "$themes" >>"$log"

  # Show picker
  local sel=""
  sel="$(printf "%s\n" "$themes" | menu-pick "Themes" 800 400 630 || true)"
  echo "Selected: '$sel'" >>"$log"

  [[ -n "$sel" ]] || return 0

  if ! command -v theme-set >/dev/null 2>&1; then
    echo "ERROR: theme-set not found" >>"$log"
    notify-send "Themes" "theme-set not found (see $log)"
    return 1
  fi

  theme-set "$sel" >>"$log" 2>&1 &
  disown || true
  exit 0
}

manage_menu() {
  case "$(menu "Manage" \
    "󰔎  Toggle
  Restart
󰣇  Install
󰭌  Remove
Return to Main Menu")" in
  *Toggle*) manage_toggle_menu ;;
  *Restart*) manage_restart_menu ;;
  *Install*) manage_install_menu ;;
  *Remove*) manage_remove_menu ;;
  *Return*) main_menu ;;
  esac
  exit 0
}

manage_toggle_menu() {
  case "$(menu "Toggle" \
    "󰍜  Waybar
󰔎  Nightlight
󱫖  Idle Lock
󱄄  Screensaver
Return to Manage")" in
  *Waybar*) toggle-waybar ;;
  *Nightlight*) toggle-nightlight ;;
  *Idle*) toggle-idle ;;
  *Return*) manage_menu ;;
  esac
  exit 0
}

manage_restart_menu() {
  case "$(menu "Restart" \
    "󰂯  Bluetooth
  btop
  Hyprctl
  PipeWire
󱂬  SwayNC
󰍝  SwayOSD
󰌧  Walker
󰍜  Waybar
󱚾  Wi-Fi
Return to Manage")" in
  *Bluetooth*) restart-bluetooth ;;
  *btop*) restart-btop ;;
  *Hyprctl*) restart-hyprctl ;;
  *PipeWire*) restart-pipewire ;;
  *SwayNC*) restart-swaync ;;
  *SwayOSD*) restart-swayosd ;;
  *Walker*) restart-walker ;;
  *Waybar*) restart-waybar ;;
  *Wi-Fi*) restart-wifi ;;
  *Return*) manage_menu ;;
  esac
  exit 0
}

manage_install_menu() {
  case "$(menu "Install" \
    "󰣇  Package (repo)
󰣇  Package (AUR)
  Misc
Return to Manage")" in
  *repo*) present pkg-install ;;
  *AUR*) present pkg-aur-install ;;
  *Package*) present pkg-install ;;
  *Return*) manage_menu ;;
  esac
  exit 0
}

manage_remove_menu() {
  case "$(menu "Remove" \
    "󰣇  Remove package
󰣇  Remove orphan/extra
󰣇  Remove AUR package
Return to Manage")" in
  *Pkg*) present pkg-remove ;;
  *orphan*) present pkg-drop ;;
  *AUR*) pkg-aur-remove ;;
  *Return*) manage_menu ;;
  esac
  exit 0
}

jump() {
  case "${1:-}" in
  style) style_menu ;;
  themes) theme_menu ;;
  manage) manage_menu ;;
  toggle) manage_toggle_menu ;;
  restart) manage_restart_menu ;;
  install) manage_install_menu ;;
  remove) manage_remove_menu ;;
  *) main_menu ;;
  esac
}

# Allow calling: menu <section>
jump "${1:-}"

main_menu

case "${1:-}" in
themes) theme_menu ;;
*) main_menu ;;
esac
